<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Insurance Underwriting Co-Pilot | AI-Powered Risk Assessment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Background Elements -->
    <div class="bg-grid"></div>
    <div class="bg-gradient"></div>
    
    <div class="app-shell">
        <!-- NAVIGATION -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-left">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="logo-text">
                            <h1 class="logo-title">Underwriting Co-Pilot</h1>
                            <span class="logo-subtitle">AI-Powered Risk Intelligence v2.0</span>
                        </div>
                    </div>
                </div>
                
                <div class="navbar-right">
                    <div class="nav-badge">
                        <span class="badge-icon">ü§ñ</span>
                        <span>Enhanced ML + Business Rules</span>
                    </div>
                    <button class="btn-chat" onclick="toggleChatPanel()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>AI Assistant</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="container">
                <!-- Page Header -->
                <header class="page-header">
                    <div class="page-header-content">
                        <div class="page-title-group">
                            <h2 class="page-title">Enhanced Risk Assessment Dashboard</h2>
                            <p class="page-description">Intelligent underwriting with ML predictions, red flag detection, and business rules validation</p>
                        </div>
                        <div class="page-meta">
                            <div class="meta-item">
                                <span class="meta-label">Active Model</span>
                                <span class="meta-value">{{ default_model|default('xgboost')|replace('_',' ')|title }}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Environment</span>
                                <span class="meta-value">Enhanced v2.0</span>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Main Grid Layout -->
                <div class="dashboard-grid">
                    <!-- LEFT COLUMN - Input Form -->
                    <div class="dashboard-left">
                        <div class="card card-form">
                            <div class="card-header">
                                <div class="card-title-group">
                                    <h3 class="card-title">Application Details</h3>
                                    <p class="card-subtitle">Enter customer and policy information for risk analysis</p>
                                </div>
                                <div class="card-badge">New Assessment</div>
                            </div>

                            <div class="card-body">
                                <form id="predictionForm" class="assessment-form">
                                    <div class="form-sections">
                                        <!-- Personal Information -->
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <span class="section-icon">üë§</span>
                                                Personal Information
                                            </h4>
                                            <div class="form-grid">
                                                <div class="form-field">
                                                    <label for="Gender" class="form-label">Gender</label>
                                                    <div class="input-wrapper">
                                                        <select id="Gender" name="Gender" class="form-select" required>
                                                            <option value="Male" selected>Male</option>
                                                            <option value="Female">Female</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-field">
                                                    <label for="Age" class="form-label">Age</label>
                                                    <div class="input-wrapper">
                                                        <input type="number" id="Age" name="Age" class="form-input" min="18" max="85" value="32" required>
                                                        <span class="input-hint">18-85 years</span>
                                                    </div>
                                                </div>

                                                <div class="form-field form-field-full">
                                                    <label for="Driving_License" class="form-label">Driving License Status</label>
                                                    <div class="input-wrapper">
                                                        <select id="Driving_License" name="Driving_License" class="form-select" required>
                                                            <option value="1" selected>Valid License</option>
                                                            <option value="0">No License</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Policy Details -->
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <span class="section-icon">üìã</span>
                                                Policy Details
                                            </h4>
                                            <div class="form-grid">
                                                <div class="form-field">
                                                    <label for="Region_Code" class="form-label">Region Code</label>
                                                    <div class="input-wrapper">
                                                        <input type="number" id="Region_Code" name="Region_Code" class="form-input" min="0" max="52" value="28" required>
                                                        <span class="input-hint">0-52</span>
                                                    </div>
                                                </div>

                                                <div class="form-field">
                                                    <label for="Previously_Insured" class="form-label">Previously Insured</label>
                                                    <div class="input-wrapper">
                                                        <select id="Previously_Insured" name="Previously_Insured" class="form-select" required>
                                                            <option value="1">Yes</option>
                                                            <option value="0" selected>No</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-field">
                                                    <label for="Annual_Premium" class="form-label">Annual Premium (‚Çπ)</label>
                                                    <div class="input-wrapper">
                                                        <input type="number" id="Annual_Premium" name="Annual_Premium" class="form-input" value="25000" min="2000" max="500000" required>
                                                        <span class="input-hint">‚Çπ2,000 - ‚Çπ5,00,000</span>
                                                    </div>
                                                </div>

                                                <div class="form-field">
                                                    <label for="Policy_Sales_Channel" class="form-label">Sales Channel</label>
                                                    <div class="input-wrapper">
                                                        <input type="number" id="Policy_Sales_Channel" name="Policy_Sales_Channel" class="form-input" value="26" min="1" max="200" required>
                                                        <span class="input-hint">1-200</span>
                                                    </div>
                                                </div>

                                                <div class="form-field form-field-full">
                                                    <label for="Vintage" class="form-label">Customer Vintage (Days)</label>
                                                    <div class="input-wrapper">
                                                        <input type="number" id="Vintage" name="Vintage" class="form-input" value="120" min="10" max="365" required>
                                                        <span class="input-hint">10-365 days with company</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Vehicle Information -->
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <span class="section-icon">üöó</span>
                                                Vehicle Information
                                            </h4>
                                            <div class="form-grid">
                                                <div class="form-field">
                                                    <label for="Vehicle_Age" class="form-label">Vehicle Age</label>
                                                    <div class="input-wrapper">
                                                        <select id="Vehicle_Age" name="Vehicle_Age" class="form-select" required>
                                                            <option value="< 1 Year">&lt; 1 Year</option>
                                                            <option value="1-2 Year" selected>1-2 Years</option>
                                                            <option value="> 2 Years">&gt; 2 Years</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-field">
                                                    <label for="Vehicle_Damage" class="form-label">Damage History</label>
                                                    <div class="input-wrapper">
                                                        <select id="Vehicle_Damage" name="Vehicle_Damage" class="form-select" required>
                                                            <option value="No" selected>No Damage</option>
                                                            <option value="Yes">Yes - Reported</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Model Selection -->
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <span class="section-icon">‚öôÔ∏è</span>
                                                Model Configuration
                                            </h4>
                                            <div class="form-grid">
                                                <div class="form-field form-field-full">
                                                    <label for="model" class="form-label">ML Model</label>
                                                    <div class="input-wrapper">
                                                        <select id="model" name="model" class="form-select">
                                                            {% if model_metrics %}
                                                                {% for name, metrics in model_metrics.items() %}
                                                                    <option value="{{ name }}" {% if name == default_model %}selected{% endif %}>
                                                                        {{ name|replace('_',' ')|title }} - {{ (metrics.roc_auc * 100)|round(2) }}% ROC-AUC
                                                                    </option>
                                                                {% endfor %}
                                                            {% else %}
                                                                <option value="{{ default_model|default('xgboost') }}" selected>
                                                                    {{ default_model|default('XGBoost')|replace('_',' ')|title }}
                                                                </option>
                                                            {% endif %}
                                                        </select>
                                                        <span class="input-hint">Select prediction model</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Form Actions -->
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <span>Run Enhanced Risk Assessment</span>
                                        </button>
                                        <p class="form-note">Processing includes: Input validation ‚Üí Red flag detection ‚Üí ML prediction ‚Üí GenAI insights ‚Üí Document generation</p>
                                    </div>

                                    <!-- Loading State -->
                                    <div class="loading-state" id="loadingState">
                                        <div class="loading-spinner"></div>
                                        <div class="loading-text">
                                            <p class="loading-title">Processing Enhanced Assessment...</p>
                                            <p class="loading-subtitle">Running validation, ML models, and generating AI insights</p>
                                        </div>
                                    </div>
                                </form>

                                <!-- ========================================== -->
                                <!-- ENHANCED RESULTS SECTION -->
                                <!-- ========================================== -->
                                <div class="results-container" id="resultSection">
                                    <div class="results-header">
                                        <div class="results-title-group">
                                            <h4 class="results-title">Assessment Results</h4>
                                            <div id="riskBadge" class="risk-badge-container"></div>
                                        </div>
                                        <div class="results-meta">
                                            <div class="meta-pill">
                                                <span class="meta-pill-label">Model:</span>
                                                <span id="modelUsedText" class="meta-pill-value">‚Äî</span>
                                            </div>
                                            <div class="meta-pill">
                                                <span class="meta-pill-label">Time:</span>
                                                <span id="timestampText" class="meta-pill-value">‚Äî</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NEW: Validation Alert -->
                                    <div id="validationAlert" class="validation-alert" style="display: none;">
                                        <div id="validationErrors" class="validation-errors" style="display: none;"></div>
                                        <div id="validationWarnings" class="validation-warnings" style="display: none;"></div>
                                    </div>

                                    <div id="riskTags" class="risk-tags"></div>

                                    <!-- ENHANCED: Risk Score Card with Composite Metrics -->
                                    <div class="risk-score-card">
                                        <div class="score-header">
                                            <div>
                                                <h5 class="score-title">Composite Risk Score</h5>
                                                <p class="score-subtitle">Lower score = Better risk profile (0-100)</p>
                                            </div>
                                            <div class="score-value-large">
                                                <span id="compositeScoreText">0</span>
                                                <span class="score-unit">/100</span>
                                            </div>
                                        </div>
                                        <div class="score-bar-container">
                                            <div class="score-bar">
                                                <div class="score-fill" id="scoreFill"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Enhanced metrics grid -->
                                        <div class="score-details-enhanced">
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">üìà</span>
                                                    Customer Interest
                                                </span>
                                                <span id="businessAttractivenessText" class="detail-value detail-value-positive">‚Äî</span>
                                            </div>
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">‚ö†Ô∏è</span>
                                                    Underwriting Risk
                                                </span>
                                                <span id="underwritingRiskText" class="detail-value detail-value-negative">‚Äî</span>
                                            </div>
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">üéØ</span>
                                                    ML Probability
                                                </span>
                                                <span id="mlProbabilityText" class="detail-value">‚Äî</span>
                                            </div>
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">‚úì</span>
                                                    Confidence
                                                </span>
                                                <span id="confidenceText" class="detail-value">‚Äî</span>
                                            </div>
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">üè∑Ô∏è</span>
                                                    Risk Tier
                                                </span>
                                                <span id="tierText" class="detail-value">‚Äî</span>
                                            </div>
                                            <div class="score-detail-item">
                                                <span class="detail-label">
                                                    <span class="detail-icon">‚ö°</span>
                                                    Action
                                                </span>
                                                <span id="actionText" class="detail-value">‚Äî</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NEW: Risk Breakdown Visualization -->
                                    <div class="risk-breakdown-section">
                                        <h5 class="section-heading">
                                            <span class="section-icon">üìä</span>
                                            Risk Breakdown Analysis
                                        </h5>
                                        <div id="riskBreakdownChart" class="risk-breakdown-chart" style="display: none;"></div>
                                    </div>

                                    <!-- NEW: Red Flags Section -->
                                    <div id="redFlagsContainer" class="red-flags-section" style="display: none;">
                                        <div class="red-flags-header">
                                            <span class="red-flags-icon">üö®</span>
                                            <h5 id="redFlagsCount" class="red-flags-title">Red Flags</h5>
                                        </div>
                                        <ul id="redFlagsList" class="red-flags-list"></ul>
                                    </div>

                                    <!-- Probability Distribution -->
                                    <div class="probability-cards">
                                        <div class="prob-card prob-card-negative">
                                            <div class="prob-icon">üìâ</div>
                                            <div class="prob-content">
                                                <span class="prob-label">Not Interested</span>
                                                <span id="probNotInterested" class="prob-value">0%</span>
                                            </div>
                                        </div>
                                        <div class="prob-card prob-card-positive">
                                            <div class="prob-icon">üìà</div>
                                            <div class="prob-content">
                                                <span class="prob-label">Interested</span>
                                                <span id="probInterested" class="prob-value">0%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- AI Insights -->
                                    <div class="ai-insights">
                                        <div class="ai-insight-card">
                                            <div class="ai-card-header">
                                                <div class="ai-card-icon">ü§ñ</div>
                                                <h5 class="ai-card-title">AI Risk Summary</h5>
                                            </div>
                                            <div id="aiSummaryText" class="ai-card-content">Awaiting assessment...</div>
                                        </div>

                                        <div class="ai-insight-card">
                                            <div class="ai-card-header">
                                                <div class="ai-card-icon">üéØ</div>
                                                <h5 class="ai-card-title">Decision Rationale</h5>
                                            </div>
                                            <div id="aiRationaleText" class="ai-card-content">Awaiting assessment...</div>
                                        </div>

                                        <div class="ai-insight-card">
                                            <div class="ai-card-header">
                                                <div class="ai-card-icon">üí°</div>
                                                <h5 class="ai-card-title">Final Recommendation</h5>
                                            </div>
                                            <div id="aiRecommendationText" class="ai-card-content">Awaiting assessment...</div>
                                        </div>
                                    </div>

                                    <!-- ENHANCED: Documents Section with Special Instructions -->
                                    <div class="documents-section">
                                        <div class="documents-header">
                                            <h5 class="documents-title">Required Documents</h5>
                                            <div class="documents-badges">
                                                <span class="doc-badge"><span id="docCount">0</span> items</span>
                                                <span class="doc-badge">Urgency: <span id="docUrgency">‚Äî</span></span>
                                                <span class="doc-badge">Type: <span id="docReviewType">‚Äî</span></span>
                                            </div>
                                        </div>
                                        
                                        <!-- NEW: Special Instructions -->
                                        <div id="docSpecialInstructions" class="doc-special-instructions" style="display: none;"></div>
                                        
                                        <div id="documentsList" class="documents-list"></div>
                                        
                                        <div class="documents-footer">
                                            <div class="footer-item">
                                                <span class="footer-label">üìÖ Processing Time</span>
                                                <span class="footer-value"><span id="docEta">‚Äî</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN - Metrics & Info -->
                    <div class="dashboard-right">
                        <!-- Model Performance -->
                        <div class="card card-metrics">
                            <div class="card-header">
                                <div class="card-title-group">
                                    <h3 class="card-title">Model Performance</h3>
                                    <p class="card-subtitle">Latest evaluation metrics</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="metrics-grid">
                                    {% if model_metrics %}
                                        {% for name, metrics in model_metrics.items() %}
                                            <div class="metric-card {% if name == default_model %}metric-card-active{% endif %}">
                                                <div class="metric-header">
                                                    <span class="metric-name">{{ name|replace('_',' ')|title }}</span>
                                                    {% if name == default_model %}
                                                        <span class="metric-badge">Active</span>
                                                    {% endif %}
                                                </div>
                                                <div class="metric-value">{{ (metrics.roc_auc * 100)|round(2) }}%</div>
                                                <div class="metric-label">ROC-AUC Score</div>
                                                <div class="metric-stats">
                                                    <div class="stat-item">
                                                        <span class="stat-label">Accuracy</span>
                                                        <span class="stat-value">{{ (metrics.accuracy * 100)|round(1) }}%</span>
                                                    </div>
                                                    <div class="stat-item">
                                                        <span class="stat-label">F1 Score</span>
                                                        <span class="stat-value">{{ (metrics.f1_score * 100)|round(1) }}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="metric-card-empty">
                                            <p>Model metrics will appear here once loaded</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Info Card -->
                        <div class="card card-info">
                            <div class="card-header">
                                <div class="card-title-group">
                                    <h3 class="card-title">Enhanced Features v2.0</h3>
                                    <p class="card-subtitle">What's new in this version</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="info-items">
                                    <div class="info-item">
                                        <div class="info-icon">‚úÖ</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Input Validation</h5>
                                            <p class="info-text">Business rules engine validates inputs and detects data quality issues before processing.</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">üö®</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Red Flag Detection</h5>
                                            <p class="info-text">Automatically identifies risk indicators: no license, damage history, young drivers, etc.</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">üìä</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Composite Risk Score</h5>
                                            <p class="info-text">Combines ML probability (customer interest) with underwriting risk factors for accurate assessment.</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">üéØ</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Enhanced Features</h5>
                                            <p class="info-text">20+ engineered features including age risk bands, premium adequacy, and risk combinations.</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">ü§ñ</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Context-Aware AI</h5>
                                            <p class="info-text">GenAI insights now include validation results, red flags, and risk breakdown in recommendations.</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">üìÑ</div>
                                        <div class="info-content">
                                            <h5 class="info-title">Smart Documents</h5>
                                            <p class="info-text">Document requirements adapt based on risk tier, red flags, and special handling instructions.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="chat-header-content">
                <div class="chat-avatar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="chat-title-group">
                    <h4 class="chat-title">AI Assistant</h4>
                    <p class="chat-subtitle">Context-aware underwriting support</p>
                </div>
            </div>
            <button class="chat-close" onclick="toggleChatPanel()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        
<div class="chat-messages" id="chatMessages">
    <div class="chat-message chat-message-assistant">
        <div class="chat-message-avatar">ü§ñ</div>
        <div class="chat-message-bubble">
            Hello! I'm your AI underwriting assistant. I can help you understand risk assessments,
            explain document requirements, and answer questions about the application. How can I
            assist you today?
        </div>
    </div>
</div>

<div class="chat-input-container">
    <div class="chat-input-wrapper">
        <!-- Wrap in a form so Enter submits correctly -->
        <form id="chatForm" onsubmit="sendChatMessage(); return false;">
            <input 
                type="text" 
                id="chatInput"
                name="chatInput"
                class="chat-input"
                placeholder="Ask me about risk factors, documents, or underwriting..."
                autocomplete="off"
            />
            <button 
                type="submit" 
                class="chat-send" 
                aria-label="Send message"
            >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path 
                        d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" 
                        stroke="currentColor" 
                        stroke-width="2" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"
                    />
                </svg>
            </button>
        </form>
    </div>
    <p class="chat-hint">Press Enter to send ‚Ä¢ Context-aware responses</p>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>